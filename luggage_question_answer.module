<?php
/**
 * @file
 * Code for the luggage_question_answer feature.
 */

include_once 'luggage_question_answer.features.inc';

/**
 * Implemenets hook_permission().
 */
function luggage_question_answer_permission() {
  return array (
    'moderate questions and answers' => array (
      'title' => t('Moderate questions and answers'),
    ),
  );
}


/**
 * Implements hook_form_FORMID_alter().
 */
function luggage_question_answer_form_qa_node_form_alter(&$form, &$form_state, $form_id) {
  // If the current user doesn't have permission to moderate Q&A, disable
  // some fields.
  if (!user_access('moderate questions and answers')) {
    // Disable Answer, Answered By, and Answered By URL fields.
    $form['field_qa_answer']['#access'] = FALSE;
    $form['field_qa_answer_by']['#access'] = FALSE;
    $form['field_qa_answer_by_url']['#access'] = FALSE;
    $form['field_category']['#access'] = FALSE;
    $form['field_tags']['#access'] = FALSE;
    $form['field_qa_images']['#access'] = FALSE;
    $form['field_qa_files']['#access'] = FALSE;

    // Change the submit button to say "Ask".
    $form['actions']['submit']['#value'] = t('Ask');

    // Change the label for Abbreviated Question to Question Subject.
    $form['field_qa_question_short']['und'][0]['value']['#title'] = t('Question Subject');

  }
}

/**
 * Implements hook_page_build().
 */
function luggage_question_answer_page_build(&$page) {
  // Change the page title on adding a Q&A node.
  if (current_path() == 'node/add/qa') {
    drupal_set_title(t('Ask a Question'));
  }
}

/**
 * Implements template_preprocess_html().
 */
function luggage_question_answer_preprocess_html(&$vars) {
  if (drupal_get_path_alias() == 'qa' || substr(drupal_get_path_alias(), 0, 3) == 'qa/') {
    // Add RSS Feed to QA pages.
    drupal_add_html_head_link(array(
      'rel' => 'alternate',
      'type' => 'application/rss+xml',
      'title' => 'Questions and Answers',
      'href' => $GLOBALS['base_url'] . '/qa/rss.xml',
    ));

    // Custom CSS for QA Pages
    drupal_add_css(drupal_get_path('module', 'luggage_question_answer') . '/luggage_question_answer.css');
  }
}
